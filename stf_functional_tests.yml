---
- name: "Check that collectd is running and generating any metrics"
  hosts: overcloud_nodes
  ignore_errors: true
  become: true
  tasks:
    - import_role: name="{{ playbook_dir }}"
      tags:
        - always
    - name: "Update container_bin var"
      tags:
        - always
      block:
        - stat:
            path: "/usr/bin/podman"
          register: st_pod
        - set_fact:
            container_bin: docker
          when: not st_pod.stat.exists

    - name: "Run collectd tests"
      import_tasks: tasks/test_collectd.yml
      tags:
        - custom-stf-ceph
        - custom-stf-ceph-osp13
        - stf-connectors-osp13
        - stf-connectors-osp13-ffu
        - gnocchi-connectors-swift

    - name: "Run metrics_qdr tests"
      import_tasks: tasks/test_qdr.yml
      tags:
        - custom-stf-ceph
        - custom-stf-ceph-osp13
        - stf-connectors-osp13
        - stf-connectors-osp13-ffu
        - gnocchi-connectors-swift

- name: "Run e2e tests"
  hosts: undercloud-0
  ignore_errors: true
  become: true
  become_method: sudo
  become_user: root
  tasks:
    - name: "Run collectd Prometheus queries"  
      import_tasks: tasks/test_e2e.yml
      vars:
        prom_user: "{{ ( prom_secret.stdout_lines[0] | b64decode | split(':'))[0] }}"
        prom_pass: "{{ prom_secret.stdout_lines[1] | b64decode }}"
        prom_url: "{{ prom_route.stdout }}"
        stf_user: "quicklab"
        stf_host: "{{ stf_fqdn.stdout }}"

      tags:
        - custom-stf-ceph
        - stf-connectors-osp13-ffu
        - gnocchi-connectors-swift
